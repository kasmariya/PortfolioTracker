<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>My Net Worth</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .user-info {
            text-align: right;
        }

        .user-info h1 {
            margin: 0;
            font-size: 18px;
        }

        .user-info a {
            display: inline-block;
            margin-top: 10px;
            font-size: 14px;
            color: #007BFF;
        }

        .user-info a:hover {
            text-decoration: underline;
        }

        .mynetworth-overview {
            flex-grow: 1;
            text-align: left;
        }

        h1 {
            color: #333;
            margin: 0;
        }

        .parent-container {
            display: flex;
            justify-content: center;
        }

        .summary {
            display: flex;
            justify-content: space-between;
            width: 50%;
            text-align: left;
            font-size: 16px;
        }

        .links {
            text-align: center;
            margin-bottom: 30px;
        }

        .links a {
            margin: 0 15px;
            text-decoration: none;
            color: #007BFF;
            font-weight: bold;
        }

        .links a:hover {
            text-decoration: underline;
        }

        #networthChart {
            max-width: 500px;
            margin: 0 auto;
        }
    </style>
</head>

<body>
    <div class="header-container">
        <div class="mynetworth-overview">
            <h1>My Net Worth</h1>
        </div>
        <div class="user-info">
            <h1>Welcome, {{ current_user.username }}!</h1>
            <a href="{{ url_for('logout') }}">Logout</a>
        </div>
    </div>

    <!-- Privacy Mode Toggle -->
    <div class="privacy-toggle">
        <label class="switch">
            <input type="checkbox" id="privacyToggle" onchange="toggleMask()">
            <span class="slider round"></span>
        </label>
        <span class="privacy-label">Privacy Mode</span>
    </div>

    <div class="summary">
        <p><strong>Stock Value:</strong> <span class="maskable"> {{ total_value }}</span></p>
        <p><strong>Mutual Fund Value:</strong><span class="maskable"> {{ total_market_value }}</span></p>
        <p><strong>Total Net Worth:</strong><span class="maskable"> {{ my_net_worth }}</span></p>
    </div>

    <div class="chart-container">
        <div style="padding-bottom: 60px;"></div>
        <canvas id="networthChart"></canvas>
    </div>

    <script>
        // Masking
        let masked = sessionStorage.getItem('mask') === 'true';

        function applyMask() {
            const elements = document.querySelectorAll('.maskable');
            elements.forEach(el => {
                if (masked) {
                    if (!el.dataset.original) {
                        el.dataset.original = el.textContent;
                    }
                    el.textContent = '****';
                } else {
                    if (el.dataset.original) {
                        el.textContent = el.dataset.original;
                    }
                }
            });

            const toggle = document.getElementById('privacyToggle');
            if (toggle) toggle.checked = masked;
        }

        function toggleMask() {
            masked = !masked;
            sessionStorage.setItem('mask', masked);

            fetch('/update_mask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mask: masked })
            });

            applyMask();
        }

        window.addEventListener('DOMContentLoaded', applyMask);

        // Chart
        const stockValue = parseFloat("{{ stock_raw }}");
        const mfValue = parseFloat("{{ mf_raw }}");
        const ctx = document.getElementById('networthChart').getContext('2d');

        const chart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Stocks', 'Mutual Funds'],
                datasets: [{
                    data: [stockValue, mfValue],
                    backgroundColor: ['#4e79a7', '#f28e2b']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    datalabels: {
                        formatter: (value, ctx) => {
                            let sum = 0;
                            let dataArr = ctx.chart.data.datasets[0].data;
                            dataArr.map(data => sum += data);
                            let percentage = (value * 100 / sum).toFixed(1) + "%";
                            return percentage;
                        },
                        color: '#fff',
                        font: {
                            weight: 'bold',
                            size: 14
                        }
                    }
                },
                plugins: [ChartDataLabels],
                onClick: (e) => {
                    const activePoints = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                    if (activePoints.length) {
                        const firstPoint = activePoints[0];
                        const index = firstPoint.index;
                        if (index === 0) {
                            // Link to the Stock Portfolio
                            window.location.href = "{{ url_for('portfolio_view') }}";
                        } else if (index === 1) {
                            // Link to the Mutual Fund Portfolio
                            window.location.href = "{{ url_for('mf_portfolio_view') }}";
                        }
                    }
                }
            }
        });
    </script>
    <div style="padding-bottom: 20px;"></div>
    <div class="parent-container">
        <a href="{{ url_for('portfolio_view') }}" style="color: green;">Stock Portfolio</a>&nbsp;|&nbsp;
        <a href="{{ url_for('mf_portfolio_view') }}" style="color: green;">Mutual Fund Portfolio</a>
    </div>
</body>

</html>
